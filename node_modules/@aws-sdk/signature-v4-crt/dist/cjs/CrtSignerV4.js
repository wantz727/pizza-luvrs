"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.CrtSignerV4 = void 0;
const querystring_parser_1 = require("@aws-sdk/querystring-parser");
const signature_v4_1 = require("@aws-sdk/signature-v4");
const aws_crt_1 = require("aws-crt");
const constants_1 = require("./constants");
const headerUtil_1 = require("./headerUtil");
/* private function to convert sdk Http request to crt Http request */
function sdkHttpRequest2crtHttpRequest(sdkRequest) {
    /* Remove the x-amz-content-sha256 header, if exists */
    (0, headerUtil_1.deleteHeader)(constants_1.SHA256_HEADER, sdkRequest.headers);
    const headersArray = Object.entries(sdkRequest.headers);
    const crtHttpHeaders = new aws_crt_1.http.HttpHeaders(headersArray);
    const queryString = (0, signature_v4_1.getCanonicalQuery)(sdkRequest);
    /**
     * Not converting the body to the crtRequest. For now, it's better to get the payload Hash from SDK.
     * The body value will be set from config.
     */
    return new aws_crt_1.http.HttpRequest(sdkRequest.method, sdkRequest.path + "?" + queryString, crtHttpHeaders);
}
/**
 * Based aws-crt, with the same API as signing the request from SignatureV4, compatible with request Signer from SDK.
 * The difference between them is CrtSignerV4 only supports signing/presigning the request. The behavior of two signers
 * are slightly different, includes the case of headers name after signing and the CrtSignerV4 does NOT support overwrite
 * the internal check against (x-amzn-trace-id, user-agent), which will always be skipped.
 * Most importantly, CrtSignerV4 supports Signature V4 Asymmetric.
 *
 * Note: aws-crt that supports SigV4A is still a private repo https://github.com/awslabs/aws-crt-nodejs-staging/tree/sigv4a-binding
 */
class CrtSignerV4 {
    constructor({ credentials, region, service, sha256, applyChecksum = true, uriEscapePath = true, signingAlgorithm = aws_crt_1.auth.AwsSigningAlgorithm.SigV4, }) {
        this.service = service;
        this.sha256 = sha256;
        this.uriEscapePath = uriEscapePath;
        this.signingAlgorithm = signingAlgorithm;
        this.applyChecksum = applyChecksum;
        this.regionProvider = (0, signature_v4_1.normalizeRegionProvider)(region);
        this.credentialProvider = (0, signature_v4_1.normalizeCredentialsProvider)(credentials);
        aws_crt_1.io.enable_logging(aws_crt_1.io.LogLevel.ERROR);
    }
    async options2crtConfigure({ signingDate = new Date(), signableHeaders, unsignableHeaders, signingRegion, signingService, } = {}, viaHeader, payloadHash, expiresIn) {
        const credentials = await this.credentialProvider();
        const region = signingRegion !== null && signingRegion !== void 0 ? signingRegion : (await this.regionProvider());
        const service = signingService !== null && signingService !== void 0 ? signingService : this.service;
        if ((signableHeaders === null || signableHeaders === void 0 ? void 0 : signableHeaders.has("x-amzn-trace-id")) || (signableHeaders === null || signableHeaders === void 0 ? void 0 : signableHeaders.has("user-agent"))) {
            throw new Error("internal check (x-amzn-trace-id, user-agent) is not supported to be included to sign with CRT.");
        }
        const headersUnsignable = getHeadersUnsignable(unsignableHeaders, signableHeaders);
        return {
            algorithm: this.signingAlgorithm,
            signature_type: viaHeader
                ? aws_crt_1.auth.AwsSignatureType.HttpRequestViaHeaders
                : aws_crt_1.auth.AwsSignatureType.HttpRequestViaQueryParams,
            provider: sdk2crtCredentialsProvider(credentials),
            region: region,
            service: service,
            date: new Date(signingDate),
            header_blacklist: headersUnsignable,
            use_double_uri_encode: this.uriEscapePath,
            /* Always set the body value by the result from SDK */
            signed_body_value: payloadHash,
            signed_body_header: this.applyChecksum && viaHeader
                ? aws_crt_1.auth.AwsSignedBodyHeaderType.XAmzContentSha256
                : aws_crt_1.auth.AwsSignedBodyHeaderType.None,
            expiration_in_seconds: expiresIn,
        };
    }
    async presign(originalRequest, options = {}) {
        if (options.expiresIn && options.expiresIn > constants_1.MAX_PRESIGNED_TTL) {
            return Promise.reject("Signature version 4 presigned URLs" + " must have an expiration date less than one week in" + " the future");
        }
        const request = (0, signature_v4_1.moveHeadersToQuery)((0, signature_v4_1.prepareRequest)(originalRequest));
        const crtSignedRequest = await this.signRequest(request, await this.options2crtConfigure(options, false /* viaHeader */, await (0, signature_v4_1.getPayloadHash)(originalRequest, this.sha256), options.expiresIn ? options.expiresIn : 3600));
        request.query = this.getQueryParam(crtSignedRequest.path);
        return request;
    }
    async sign(toSign, options) {
        const request = (0, signature_v4_1.prepareRequest)(toSign);
        const crtSignedRequest = await this.signRequest(request, await this.options2crtConfigure(options, true /* viaHeader */, await (0, signature_v4_1.getPayloadHash)(toSign, this.sha256)));
        request.headers = crtSignedRequest.headers._flatten().reduce((acc, [key, value]) => ({ ...acc, [key]: value }), {});
        return request;
    }
    /* Get the query parameters from crtPath */
    getQueryParam(crtPath) {
        const start = crtPath.search(/\?/);
        const startHash = crtPath.search(/\#/);
        const end = startHash == -1 ? undefined : startHash;
        const queryParam = {};
        if (start == -1) {
            return queryParam;
        }
        const queryString = crtPath.slice(start + 1, end);
        return (0, querystring_parser_1.parseQueryString)(queryString);
    }
    async signRequest(requestToSign, crtConfig) {
        const request = sdkHttpRequest2crtHttpRequest(requestToSign);
        // if (requestToSign.headers[TOKEN_HEADER])
        try {
            return await aws_crt_1.auth.aws_sign_request(request, crtConfig);
        }
        catch (error) {
            throw new Error(error);
        }
    }
    /**
     * Test-only API used for cross-library signing verification tests. Verify sign.
     *
     * Verifies:
     *  (1) The canonical request generated during sigv4a signing of the request matches what is passed in
     *  (2) The signature passed in is a valid ECDSA signature of the hashed string-to-sign derived from the
     *  canonical request
     *
     * @param request The original request used for signing
     * @param signature the actual signature computed from a previous signing of the signable
     * @param expectedCanonicalRequest expected result when building the canonical request
     * @param eccPubKeyX the x coordinate of the public part of the ecc key to verify the signature
     * @param eccPubKeyY the y coordinate of the public part of the ecc key to verify the signature
     * @param options the RequestSigningArguments used for signing
     *
     * @return True, if the verification succeed. Otherwise, false.
     */
    async verifySigv4aSigning(request, signature, expectedCanonicalRequest, eccPubKeyX, eccPubKeyY, options = {}) {
        const sdkRequest = (0, signature_v4_1.prepareRequest)(request);
        const crtRequest = sdkHttpRequest2crtHttpRequest(sdkRequest);
        const payloadHash = await (0, signature_v4_1.getPayloadHash)(request, this.sha256);
        const crtConfig = await this.options2crtConfigure(options, true /* viaHeader */, payloadHash);
        return aws_crt_1.auth.aws_verify_sigv4a_signing(crtRequest, crtConfig, expectedCanonicalRequest, signature, eccPubKeyX, eccPubKeyY);
    }
    /* Verify presign */
    async verifySigv4aPreSigning(request, signature, expectedCanonicalRequest, eccPubKeyX, eccPubKeyY, options = {}) {
        if (typeof signature != "string") {
            return false;
        }
        const sdkRequest = (0, signature_v4_1.prepareRequest)(request);
        const crtRequest = sdkHttpRequest2crtHttpRequest(sdkRequest);
        const crtConfig = await this.options2crtConfigure(options, false /* viaHeader */, await (0, signature_v4_1.getPayloadHash)(request, this.sha256), options.expiresIn ? options.expiresIn : 3600);
        return aws_crt_1.auth.aws_verify_sigv4a_signing(crtRequest, crtConfig, expectedCanonicalRequest, signature, eccPubKeyX, eccPubKeyY);
    }
}
exports.CrtSignerV4 = CrtSignerV4;
function sdk2crtCredentialsProvider(credentials) {
    return aws_crt_1.auth.AwsCredentialsProvider.newStatic(credentials.accessKeyId, credentials.secretAccessKey, credentials.sessionToken);
}
function getHeadersUnsignable(unsignableHeaders, signableHeaders) {
    if (!unsignableHeaders) {
        return [];
    }
    if (!signableHeaders) {
        return [...unsignableHeaders];
    }
    const result = new Set([...unsignableHeaders]);
    for (let it = signableHeaders.values(), val = null; (val = it.next().value);) {
        if (result.has(val)) {
            result.delete(val);
        }
    }
    return [...result];
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQ3J0U2lnbmVyVjQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvQ3J0U2lnbmVyVjQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEsb0VBQStEO0FBQy9ELHdEQVMrQjtBQVcvQixxQ0FBd0U7QUFFeEUsMkNBQStEO0FBQy9ELDZDQUE0QztBQUk1QyxzRUFBc0U7QUFDdEUsU0FBUyw2QkFBNkIsQ0FBQyxVQUF1QjtJQUM1RCx1REFBdUQ7SUFDdkQsSUFBQSx5QkFBWSxFQUFDLHlCQUFhLEVBQUUsVUFBVSxDQUFDLE9BQU8sQ0FBQyxDQUFDO0lBQ2hELE1BQU0sWUFBWSxHQUFHLE1BQU0sQ0FBQyxPQUFPLENBQUMsVUFBVSxDQUFDLE9BQU8sQ0FBQyxDQUFDO0lBQ3hELE1BQU0sY0FBYyxHQUFHLElBQUksY0FBTyxDQUFDLFdBQVcsQ0FBQyxZQUFZLENBQUMsQ0FBQztJQUM3RCxNQUFNLFdBQVcsR0FBRyxJQUFBLGdDQUFpQixFQUFDLFVBQVUsQ0FBQyxDQUFDO0lBRWxEOzs7T0FHRztJQUNILE9BQU8sSUFBSSxjQUFPLENBQUMsV0FBVyxDQUFDLFVBQVUsQ0FBQyxNQUFNLEVBQUUsVUFBVSxDQUFDLElBQUksR0FBRyxHQUFHLEdBQUcsV0FBVyxFQUFFLGNBQWMsQ0FBQyxDQUFDO0FBQ3pHLENBQUM7QUFXRDs7Ozs7Ozs7R0FRRztBQUNILE1BQWEsV0FBVztJQVN0QixZQUFZLEVBQ1YsV0FBVyxFQUNYLE1BQU0sRUFDTixPQUFPLEVBQ1AsTUFBTSxFQUNOLGFBQWEsR0FBRyxJQUFJLEVBQ3BCLGFBQWEsR0FBRyxJQUFJLEVBQ3BCLGdCQUFnQixHQUFHLGNBQU8sQ0FBQyxtQkFBbUIsQ0FBQyxLQUFLLEdBQ1o7UUFDeEMsSUFBSSxDQUFDLE9BQU8sR0FBRyxPQUFPLENBQUM7UUFDdkIsSUFBSSxDQUFDLE1BQU0sR0FBRyxNQUFNLENBQUM7UUFDckIsSUFBSSxDQUFDLGFBQWEsR0FBRyxhQUFhLENBQUM7UUFDbkMsSUFB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LFdBQVcsQ0FBQyxZQUFZLENBQ3pCLENBQUM7QUFDSixDQUFDO0FBRUQsU0FBUyxvQkFBb0IsQ0FBQyxpQkFBK0IsRUFBRSxlQUE2QjtJQUMxRixJQUFJLENBQUMsaUJBQWlCLEVBQUU7UUFDdEIsT0FBTyxFQUFFLENBQUM7S0FDWDtJQUNELElBQUksQ0FBQyxlQUFlLEVBQUU7UUFDcEIsT0FBTyxDQUFDLEdBQUcsaUJBQWlCLENBQUMsQ0FBQztLQUMvQjtJQUNELE1BQU0sTUFBTSxHQUFHLElBQUksR0FBRyxDQUFDLENBQUMsR0FBRyxpQkFBaUIsQ0FBQyxDQUFDLENBQUM7SUFDL0MsS0FBSyxJQUFJLEVBQUUsR0FBRyxlQUFlLENBQUMsTUFBTSxFQUFFLEVBQUUsR0FBRyxHQUFHLElBQUksRUFBRSxDQUFDLEdBQUcsR0FBRyxFQUFFLENBQUMsSUFBSSxFQUFFLENBQUMsS0FBSyxDQUFDLEdBQUk7UUFDN0UsSUFBSSxNQUFNLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxFQUFFO1lBQ25CLE1BQU0sQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUM7U0FDcEI7S0FDRjtJQUNELE9BQU8sQ0FBQyxHQUFHLE1BQU0sQ0FBQyxDQUFDO0FBQ3JCLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBwYXJzZVF1ZXJ5U3RyaW5nIH0gZnJvbSBcIkBhd3Mtc2RrL3F1ZXJ5c3RyaW5nLXBhcnNlclwiO1xuaW1wb3J0IHtcbiAgZ2V0Q2Fub25pY2FsUXVlcnksXG4gIGdldFBheWxvYWRIYXNoLFxuICBtb3ZlSGVhZGVyc1RvUXVlcnksXG4gIG5vcm1hbGl6ZUNyZWRlbnRpYWxzUHJvdmlkZXIsXG4gIG5vcm1hbGl6ZVJlZ2lvblByb3ZpZGVyLFxuICBwcmVwYXJlUmVxdWVzdCxcbiAgU2lnbmF0dXJlVjRDcnlwdG9Jbml0LFxuICBTaWduYXR1cmVWNEluaXQsXG59IGZyb20gXCJAYXdzLXNkay9zaWduYXR1cmUtdjRcIjtcbmltcG9ydCB7XG4gIENyZWRlbnRpYWxzLFxuICBIdHRwUmVxdWVzdCxcbiAgUHJvdmlkZXIsXG4gIFF1ZXJ5UGFyYW1ldGVyQmFnLFxuICBSZXF1ZXN0UHJlc2lnbmVyLFxuICBSZXF1ZXN0UHJlc2lnbmluZ0FyZ3VtZW50cyxcbiAgUmVxdWVzdFNpZ25lcixcbiAgUmVxdWVzdFNpZ25pbmdBcmd1bWVudHMsXG59IGZyb20gXCJAYXdzLXNkay90eXBlc1wiO1xuaW1wb3J0IHsgYXV0aCBhcyBjcnRBdXRoLCBodHRwIGFzIGNydEh0dHAsIGlvIGFzIGNydElPIH0gZnJvbSBcImF3cy1jcnRcIjtcblxuaW1wb3J0IHsgTUFYX1BSRVNJR05FRF9UVEwsIFNIQTI1Nl9IRUFERVIgfSBmcm9tIFwiLi9jb25zdGFudHNcIjtcbmltcG9ydCB7IGRlbGV0ZUhlYWRlciB9IGZyb20gXCIuL2hlYWRlclV0aWxcIjtcblxuZXhwb3J0IHR5cGUgQXdzU2lnbmluZ0FsZ29yaXRobSA9IGNydEF1dGguQXdzU2lnbmluZ0FsZ29yaXRobTtcblxuLyogcHJpdmF0ZSBmdW5jdGlvbiB0byBjb252ZXJ0IHNkayBIdHRwIHJlcXVlc3QgdG8gY3J0IEh0dHAgcmVxdWVzdCAqL1xuZnVuY3Rpb24gc2RrSHR0cFJlcXVlc3QyY3J0SHR0cFJlcXVlc3Qoc2RrUmVxdWVzdDogSHR0cFJlcXVlc3QpOiBjcnRIdHRwLkh0dHBSZXF1ZXN0IHtcbiAgLyogUmVtb3ZlIHRoZSB4LWFtei1jb250ZW50LXNoYTI1NiBoZWFkZXIsIGlmIGV4aXN0cyAqL1xuICBkZWxldGVIZWFkZXIoU0hBMjU2X0hFQURFUiwgc2RrUmVxdWVzdC5oZWFkZXJzKTtcbiAgY29uc3QgaGVhZGVyc0FycmF5ID0gT2JqZWN0LmVudHJpZXMoc2RrUmVxdWVzdC5oZWFkZXJzKTtcbiAgY29uc3QgY3J0SHR0cEhlYWRlcnMgPSBuZXcgY3J0SHR0cC5IdHRwSGVhZGVycyhoZWFkZXJzQXJyYXkpO1xuICBjb25zdCBxdWVyeVN0cmluZyA9IGdldENhbm9uaWNhbFF1ZXJ5KHNka1JlcXVlc3QpO1xuXG4gIC8qKlxuICAgKiBOb3QgY29udmVydGluZyB0aGUgYm9keSB0byB0aGUgY3J0UmVxdWVzdC4gRm9yIG5vdywgaXQncyBiZXR0ZXIgdG8gZ2V0IHRoZSBwYXlsb2FkIEhhc2ggZnJvbSBTREsuXG4gICAqIFRoZSBib2R5IHZhbHVlIHdpbGwgYmUgc2V0IGZyb20gY29uZmlnLlxuICAgKi9cbiAgcmV0dXJuIG5ldyBjcnRIdHRwLkh0dHBSZXF1ZXN0KHNka1JlcXVlc3QubWV0aG9kLCBzZGtSZXF1ZXN0LnBhdGggKyBcIj9cIiArIHF1ZXJ5U3RyaW5nLCBjcnRIdHRwSGVhZGVycyk7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgQ3J0U2lnbmVyVjRJbml0IGV4dGVuZHMgU2lnbmF0dXJlVjRJbml0IHtcbiAgLyoqXG4gICAqIFRoZSBBbGdvcml0aG0gdXNlZCBmb3IgdGhlIHNpZ25lci4gSW5jbHVkZXM6IFNpZ1Y0LCBTaWdWNEFzeW1tZXRyaWMuXG4gICAqXG4gICAqIEBkZWZhdWx0IFtTaWdWNF1cbiAgICovXG4gIHNpZ25pbmdBbGdvcml0aG0/OiBBd3NTaWduaW5nQWxnb3JpdGhtO1xufVxuXG4vKipcbiAqIEJhc2VkIGF3cy1jcnQsIHdpdGggdGhlIHNhbWUgQVBJIGFzIHNpZ25pbmcgdGhlIHJlcXVlc3QgZnJvbSBTaWduYXR1cmVWNCwgY29tcGF0aWJsZSB3aXRoIHJlcXVlc3QgU2lnbmVyIGZyb20gU0RLLlxuICogVGhlIGRpZmZlcmVuY2UgYmV0d2VlbiB0aGVtIGlzIENydFNpZ25lclY0IG9ubHkgc3VwcG9ydHMgc2lnbmluZy9wcmVzaWduaW5nIHRoZSByZXF1ZXN0LiBUaGUgYmVoYXZpb3Igb2YgdHdvIHNpZ25lcnNcbiAqIGFyZSBzbGlnaHRseSBkaWZmZXJlbnQsIGluY2x1ZGVzIHRoZSBjYXNlIG9mIGhlYWRlcnMgbmFtZSBhZnRlciBzaWduaW5nIGFuZCB0aGUgQ3J0U2lnbmVyVjQgZG9lcyBOT1Qgc3VwcG9ydCBvdmVyd3JpdGVcbiAqIHRoZSBpbnRlcm5hbCBjaGVjayBhZ2FpbnN0ICh4LWFtem4tdHJhY2UtaWQsIHVzZXItYWdlbnQpLCB3aGljaCB3aWxsIGFsd2F5cyBiZSBza2lwcGVkLlxuICogTW9zdCBpbXBvcnRhbnRseSwgQ3J0U2lnbmVyVjQgc3VwcG9ydHMgU2lnbmF0dXJlIFY0IEFzeW1tZXRyaWMuXG4gKlxuICogTm90ZTogYXdzLWNydCB0aGF0IHN1cHBvcnRzIFNpZ1Y0QSBpcyBzdGlsbCBhIHByaXZhdGUgcmVwbyBodHRwczovL2dpdGh1Yi5jb20vYXdzbGFicy9hd3MtY3J0LW5vZGVqcy1zdGFnaW5nL3RyZWUvc2lndjRhLWJpbmRpbmdcbiAqL1xuZXhwb3J0IGNsYXNzIENydFNpZ25lclY0IGltcGxlbWVudHMgUmVxdWVzdFByZXNpZ25lciwgUmVxdWVzdFNpZ25lciB7XG4gIHByaXZhdGUgcmVhZG9ubHkgc2VydmljZTogc3RyaW5nO1xuICBwcml2YXRlIHJlYWRvbmx5IHJlZ2lvblByb3ZpZGVyOiBQcm92aWRlcjxzdHJpbmc+O1xuICBwcml2YXRlIHJlYWRvbmx5IGNyZWRlbnRpYWxQcm92aWRlcjogUHJvdmlkZXI8Q3JlZGVudGlhbHM+O1xuICBwcml2YXRlIHJlYWRvbmx5IHNoYTI1NjogYW55O1xuICBwcml2YXRlIHJlYWRvbmx5IHVyaUVzY2FwZVBhdGg6IGJvb2xlYW47XG4gIHByaXZhdGUgcmVhZG9ubHkgYXBwbHlDaGVja3N1bTogYm9vbGVhbjtcbiAgcHJpdmF0ZSByZWFkb25seSBzaWduaW5nQWxnb3JpdGhtOiBBd3NTaWduaW5nQWxnb3JpdGhtO1xuXG4gIGNvbnN0cnVjdG9yKHtcbiAgICBjcmVkZW50aWFscyxcbiAgICByZWdpb24sXG4gICAgc2VydmljZSxcbiAgICBzaGEyNTYsXG4gICAgYXBwbHlDaGVja3N1bSA9IHRydWUsXG4gICAgdXJpRXNjYXBlUGF0aCA9IHRydWUsXG4gICAgc2lnbmluZ0FsZ29yaXRobSA9IGNydEF1dGguQXdzU2lnbmluZ0FsZ29yaXRobS5TaWdWNCxcbiAgfTogQ3J0U2lnbmVyVjRJbml0ICYgU2lnbmF0dXJlVjRDcnlwdG9Jbml0KSB7XG4gICAgdGhpcy5zZXJ2aWNlID0gc2VydmljZTtcbiAgICB0aGlzLnNoYTI1NiA9IHNoYTI1NjtcbiAgICB0aGlzLnVyaUVzY2FwZVBhdGggPSB1cmlFc2NhcGVQYXRoO1xuICAgIHRoaXMuc2lnbmluZ0FsZ29yaXRobSA9IHNpZ25pbmdBbGdvcml0aG07XG4gICAgdGhpcy5hcHBseUNoZWNrc3VtID0gYXBwbHlDaGVja3N1bTtcbiAgICB0aGlzLnJlZ2lvblByb3ZpZGVyID0gbm9ybWFsaXplUmVnaW9uUHJvdmlkZXIocmVnaW9uKTtcbiAgICB0aGlzLmNyZWRlbnRpYWxQcm92aWRlciA9IG5vcm1hbGl6ZUNyZWRlbnRpYWxzUHJvdmlkZXIoY3JlZGVudGlhbHMpO1xuICAgIGNydElPLmVuYWJsZV9sb2dnaW5nKGNydElPLkxvZ0xldmVsLkVSUk9SKTtcbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgb3B0aW9uczJjcnRDb25maWd1cmUoXG4gICAge1xuICAgICAgc2lnbmluZ0RhdGUgPSBuZXcgRGF0ZSgpLFxuICAgICAgc2lnbmFibGVIZWFkZXJzLFxuICAgICAgdW5zaWduYWJsZUhlYWRlcnMsXG4gICAgICBzaWduaW5nUmVnaW9uLFxuICAgICAgc2lnbmluZ1NlcnZpY2UsXG4gICAgfTogUmVxdWVzdFNpZ25pbmdBcmd1bWVudHMgfCBSZXF1ZXN0UHJlc2lnbmluZ0FyZ3VtZW50cyB8IHVuZGVmaW5lZCA9IHt9LFxuICAgIHZpYUhlYWRlcjogQm9vbGVhbixcbiAgICBwYXlsb2FkSGFzaDogc3RyaW5nLFxuICAgIGV4cGlyZXNJbj86IG51bWJlclxuICApOiBQcm9taXNlPGNydEF1dGguQXdzU2lnbmluZ0NvbmZpZz4ge1xuICAgIGNvbnN0IGNyZWRlbnRpYWxzID0gYXdhaXQgdGhpcy5jcmVkZW50aWFsUHJvdmlkZXIoKTtcbiAgICBjb25zdCByZWdpb24gPSBzaWduaW5nUmVnaW9uID8/IChhd2FpdCB0aGlzLnJlZ2lvblByb3ZpZGVyKCkpO1xuICAgIGNvbnN0IHNlcnZpY2UgPSBzaWduaW5nU2VydmljZSA/PyB0aGlzLnNlcnZpY2U7XG4gICAgaWYgKHNpZ25hYmxlSGVhZGVycz8uaGFzKFwieC1hbXpuLXRyYWNlLWlkXCIpIHx8IHNpZ25hYmxlSGVhZGVycz8uaGFzKFwidXNlci1hZ2VudFwiKSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFwiaW50ZXJuYWwgY2hlY2sgKHgtYW16bi10cmFjZS1pZCwgdXNlci1hZ2VudCkgaXMgbm90IHN1cHBvcnRlZCB0byBiZSBpbmNsdWRlZCB0byBzaWduIHdpdGggQ1JULlwiKTtcbiAgICB9XG4gICAgY29uc3QgaGVhZGVyc1Vuc2lnbmFibGUgPSBnZXRIZWFkZXJzVW5zaWduYWJsZSh1bnNpZ25hYmxlSGVhZGVycywgc2lnbmFibGVIZWFkZXJzKTtcbiAgICByZXR1cm4ge1xuICAgICAgYWxnb3JpdGhtOiB0aGlzLnNpZ25pbmdBbGdvcml0aG0sXG4gICAgICBzaWduYXR1cmVfdHlwZTogdmlhSGVhZGVyXG4gICAgICAgID8gY3J0QXV0aC5Bd3NTaWduYXR1cmVUeXBlLkh0dHBSZXF1ZXN0VmlhSGVhZGVyc1xuICAgICAgICA6IGNydEF1dGguQXdzU2lnbmF0dXJlVHlwZS5IdHRwUmVxdWVzdFZpYVF1ZXJ5UGFyYW1zLFxuICAgICAgcHJvdmlkZXI6IHNkazJjcnRDcmVkZW50aWFsc1Byb3ZpZGVyKGNyZWRlbnRpYWxzKSxcbiAgICAgIHJlZ2lvbjogcmVnaW9uLFxuICAgICAgc2VydmljZTogc2VydmljZSxcbiAgICAgIGRhdGU6IG5ldyBEYXRlKHNpZ25pbmdEYXRlKSxcbiAgICAgIGhlYWRlcl9ibGFja2xpc3Q6IGhlYWRlcnNVbnNpZ25hYmxlLFxuICAgICAgdXNlX2RvdWJsZV91cmlfZW5jb2RlOiB0aGlzLnVyaUVzY2FwZVBhdGgsXG4gICAgICAvKiBBbHdheXMgc2V0IHRoZSBib2R5IHZhbHVlIGJ5IHRoZSByZXN1bHQgZnJvbSBTREsgKi9cbiAgICAgIHNpZ25lZF9ib2R5X3ZhbHVlOiBwYXlsb2FkSGFzaCxcbiAgICAgIHNpZ25lZF9ib2R5X2hlYWRlcjpcbiAgICAgICAgdGhpcy5hcHBseUNoZWNrc3VtICYmIHZpYUhlYWRlclxuICAgICAgICAgID8gY3J0QXV0aC5Bd3NTaWduZWRCb2R5SGVhZGVyVHlwZS5YQW16Q29udGVudFNoYTI1NlxuICAgICAgICAgIDogY3J0QXV0aC5Bd3NTaWduZWRCb2R5SGVhZGVyVHlwZS5Ob25lLFxuICAgICAgZXhwaXJhdGlvbl9pbl9zZWNvbmRzOiBleHBpcmVzSW4sXG4gICAgfTtcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBwcmVzaWduKG9yaWdpbmFsUmVxdWVzdDogSHR0cFJlcXVlc3QsIG9wdGlvbnM6IFJlcXVlc3RQcmVzaWduaW5nQXJndW1lbnRzID0ge30pOiBQcm9taXNlPEh0dHBSZXF1ZXN0PiB7XG4gICAgaWYgKG9wdGlvbnMuZXhwaXJlc0luICYmIG9wdGlvbnMuZXhwaXJlc0luID4gTUFYX1BSRVNJR05FRF9UVEwpIHtcbiAgICAgIHJldHVybiBQcm9taXNlLnJlamVjdChcbiAgICAgICAgXCJTaWduYXR1cmUgdmVyc2lvbiA0IHByZXNpZ25lZCBVUkxzXCIgKyBcIiBtdXN0IGhhdmUgYW4gZXhwaXJhdGlvbiBkYXRlIGxlc3MgdGhhbiBvbmUgd2VlayBpblwiICsgXCIgdGhlIGZ1dHVyZVwiXG4gICAgICApO1xuICAgIH1cbiAgICBjb25zdCByZXF1ZXN0ID0gbW92ZUhlYWRlcnNUb1F1ZXJ5KHByZXBhcmVSZXF1ZXN0KG9yaWdpbmFsUmVxdWVzdCkpO1xuXG4gICAgY29uc3QgY3J0U2lnbmVkUmVxdWVzdCA9IGF3YWl0IHRoaXMuc2lnblJlcXVlc3QoXG4gICAgICByZXF1ZXN0LFxuICAgICAgYXdhaXQgdGhpcy5vcHRpb25zMmNydENvbmZpZ3VyZShcbiAgICAgICAgb3B0aW9ucyxcbiAgICAgICAgZmFsc2UgLyogdmlhSGVhZGVyICovLFxuICAgICAgICBhd2FpdCBnZXRQYXlsb2FkSGFzaChvcmlnaW5hbFJlcXVlc3QsIHRoaXMuc2hhMjU2KSxcbiAgICAgICAgb3B0aW9ucy5leHBpcmVzSW4gPyBvcHRpb25zLmV4cGlyZXNJbiA6IDM2MDBcbiAgICAgIClcbiAgICApO1xuICAgIHJlcXVlc3QucXVlcnkgPSB0aGlzLmdldFF1ZXJ5UGFyYW0oY3J0U2lnbmVkUmVxdWVzdC5wYXRoKTtcbiAgICByZXR1cm4gcmVxdWVzdDtcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBzaWduKHRvU2lnbjogSHR0cFJlcXVlc3QsIG9wdGlvbnM/OiBSZXF1ZXN0U2lnbmluZ0FyZ3VtZW50cyk6IFByb21pc2U8SHR0cFJlcXVlc3Q+IHtcbiAgICBjb25zdCByZXF1ZXN0ID0gcHJlcGFyZVJlcXVlc3QodG9TaWduKTtcbiAgICBjb25zdCBjcnRTaWduZWRSZXF1ZXN0ID0gYXdhaXQgdGhpcy5zaWduUmVxdWVzdChcbiAgICAgIHJlcXVlc3QsXG4gICAgICBhd2FpdCB0aGlzLm9wdGlvbnMyY3J0Q29uZmlndXJlKG9wdGlvbnMsIHRydWUgLyogdmlhSGVhZGVyICovLCBhd2FpdCBnZXRQYXlsb2FkSGFzaCh0b1NpZ24sIHRoaXMuc2hhMjU2KSlcbiAgICApO1xuICAgIHJlcXVlc3QuaGVhZGVycyA9IGNydFNpZ25lZFJlcXVlc3QuaGVhZGVycy5fZmxhdHRlbigpLnJlZHVjZSgoYWNjLCBba2V5LCB2YWx1ZV0pID0+ICh7IC4uLmFjYywgW2tleV06IHZhbHVlIH0pLCB7fSk7XG4gICAgcmV0dXJuIHJlcXVlc3Q7XG4gIH1cblxuICAvKiBHZXQgdGhlIHF1ZXJ5IHBhcmFtZXRlcnMgZnJvbSBjcnRQYXRoICovXG4gIHByaXZhdGUgZ2V0UXVlcnlQYXJhbShjcnRQYXRoOiBzdHJpbmcpOiBRdWVyeVBhcmFtZXRlckJhZyB7XG4gICAgY29uc3Qgc3RhcnQgPSBjcnRQYXRoLnNlYXJjaCgvXFw/Lyk7XG4gICAgY29uc3Qgc3RhcnRIYXNoID0gY3J0UGF0aC5zZWFyY2goL1xcIy8pO1xuICAgIGNvbnN0IGVuZCA9IHN0YXJ0SGFzaCA9PSAtMSA/IHVuZGVmaW5lZCA6IHN0YXJ0SGFzaDtcbiAgICBjb25zdCBxdWVyeVBhcmFtID0ge30gYXMgUXVlcnlQYXJhbWV0ZXJCYWc7XG4gICAgaWYgKHN0YXJ0ID09IC0xKSB7XG4gICAgICByZXR1cm4gcXVlcnlQYXJhbTtcbiAgICB9XG4gICAgY29uc3QgcXVlcnlTdHJpbmcgPSBjcnRQYXRoLnNsaWNlKHN0YXJ0ICsgMSwgZW5kKTtcbiAgICByZXR1cm4gcGFyc2VRdWVyeVN0cmluZyhxdWVyeVN0cmluZyk7XG4gIH1cblxuICBwcml2YXRlIGFzeW5jIHNpZ25SZXF1ZXN0KFxuICAgIHJlcXVlc3RUb1NpZ246IEh0dHBSZXF1ZXN0LFxuICAgIGNydENvbmZpZzogY3J0QXV0aC5Bd3NTaWduaW5nQ29uZmlnXG4gICk6IFByb21pc2U8Y3J0SHR0cC5IdHRwUmVxdWVzdD4ge1xuICAgIGNvbnN0IHJlcXVlc3QgPSBzZGtIdHRwUmVxdWVzdDJjcnRIdHRwUmVxdWVzdChyZXF1ZXN0VG9TaWduKTtcbiAgICAvLyBpZiAocmVxdWVzdFRvU2lnbi5oZWFkZXJzW1RPS0VOX0hFQURFUl0pXG4gICAgdHJ5IHtcbiAgICAgIHJldHVybiBhd2FpdCBjcnRBdXRoLmF3c19zaWduX3JlcXVlc3QocmVxdWVzdCwgY3J0Q29uZmlnKTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGVycm9yKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogVGVzdC1vbmx5IEFQSSB1c2VkIGZvciBjcm9zcy1saWJyYXJ5IHNpZ25pbmcgdmVyaWZpY2F0aW9uIHRlc3RzLiBWZXJpZnkgc2lnbi5cbiAgICpcbiAgICogVmVyaWZpZXM6XG4gICAqICAoMSkgVGhlIGNhbm9uaWNhbCByZXF1ZXN0IGdlbmVyYXRlZCBkdXJpbmcgc2lndjRhIHNpZ25pbmcgb2YgdGhlIHJlcXVlc3QgbWF0Y2hlcyB3aGF0IGlzIHBhc3NlZCBpblxuICAgKiAgKDIpIFRoZSBzaWduYXR1cmUgcGFzc2VkIGluIGlzIGEgdmFsaWQgRUNEU0Egc2lnbmF0dXJlIG9mIHRoZSBoYXNoZWQgc3RyaW5nLXRvLXNpZ24gZGVyaXZlZCBmcm9tIHRoZVxuICAgKiAgY2Fub25pY2FsIHJlcXVlc3RcbiAgICpcbiAgICogQHBhcmFtIHJlcXVlc3QgVGhlIG9yaWdpbmFsIHJlcXVlc3QgdXNlZCBmb3Igc2lnbmluZ1xuICAgKiBAcGFyYW0gc2lnbmF0dXJlIHRoZSBhY3R1YWwgc2lnbmF0dXJlIGNvbXB1dGVkIGZyb20gYSBwcmV2aW91cyBzaWduaW5nIG9mIHRoZSBzaWduYWJsZVxuICAgKiBAcGFyYW0gZXhwZWN0ZWRDYW5vbmljYWxSZXF1ZXN0IGV4cGVjdGVkIHJlc3VsdCB3aGVuIGJ1aWxkaW5nIHRoZSBjYW5vbmljYWwgcmVxdWVzdFxuICAgKiBAcGFyYW0gZWNjUHViS2V5WCB0aGUgeCBjb29yZGluYXRlIG9mIHRoZSBwdWJsaWMgcGFydCBvZiB0aGUgZWNjIGtleSB0byB2ZXJpZnkgdGhlIHNpZ25hdHVyZVxuICAgKiBAcGFyYW0gZWNjUHViS2V5WSB0aGUgeSBjb29yZGluYXRlIG9mIHRoZSBwdWJsaWMgcGFydCBvZiB0aGUgZWNjIGtleSB0byB2ZXJpZnkgdGhlIHNpZ25hdHVyZVxuICAgKiBAcGFyYW0gb3B0aW9ucyB0aGUgUmVxdWVzdFNpZ25pbmdBcmd1bWVudHMgdXNlZCBmb3Igc2lnbmluZ1xuICAgKlxuICAgKiBAcmV0dXJuIFRydWUsIGlmIHRoZSB2ZXJpZmljYXRpb24gc3VjY2VlZC4gT3RoZXJ3aXNlLCBmYWxzZS5cbiAgICovXG4gIHB1YmxpYyBhc3luYyB2ZXJpZnlTaWd2NGFTaWduaW5nKFxuICAgIHJlcXVlc3Q6IEh0dHBSZXF1ZXN0LFxuICAgIHNpZ25hdHVyZTogc3RyaW5nLFxuICAgIGV4cGVjdGVkQ2Fub25pY2FsUmVxdWVzdDogc3RyaW5nLFxuICAgIGVjY1B1YktleVg6IHN0cmluZyxcbiAgICBlY2NQdWJLZXlZOiBzdHJpbmcsXG4gICAgb3B0aW9uczogUmVxdWVzdFNpZ25pbmdBcmd1bWVudHMgPSB7fVxuICApOiBQcm9taXNlPGJvb2xlYW4+IHtcbiAgICBjb25zdCBzZGtSZXF1ZXN0ID0gcHJlcGFyZVJlcXVlc3QocmVxdWVzdCk7XG4gICAgY29uc3QgY3J0UmVxdWVzdCA9IHNka0h0dHBSZXF1ZXN0MmNydEh0dHBSZXF1ZXN0KHNka1JlcXVlc3QpO1xuICAgIGNvbnN0IHBheWxvYWRIYXNoID0gYXdhaXQgZ2V0UGF5bG9hZEhhc2gocmVxdWVzdCwgdGhpcy5zaGEyNTYpO1xuICAgIGNvbnN0IGNydENvbmZpZyA9IGF3YWl0IHRoaXMub3B0aW9uczJjcnRDb25maWd1cmUob3B0aW9ucywgdHJ1ZSAvKiB2aWFIZWFkZXIgKi8sIHBheWxvYWRIYXNoKTtcbiAgICByZXR1cm4gY3J0QXV0aC5hd3NfdmVyaWZ5X3NpZ3Y0YV9zaWduaW5nKFxuICAgICAgY3J0UmVxdWVzdCxcbiAgICAgIGNydENvbmZpZyxcbiAgICAgIGV4cGVjdGVkQ2Fub25pY2FsUmVxdWVzdCxcbiAgICAgIHNpZ25hdHVyZSxcbiAgICAgIGVjY1B1YktleVgsXG4gICAgICBlY2NQdWJLZXlZXG4gICAgKTtcbiAgfVxuXG4gIC8qIFZlcmlmeSBwcmVzaWduICovXG4gIHB1YmxpYyBhc3luYyB2ZXJpZnlTaWd2NGFQcmVTaWduaW5nKFxuICAgIHJlcXVlc3Q6IEh0dHBSZXF1ZXN0LFxuICAgIHNpZ25hdHVyZTogc3RyaW5nIHwgQXJyYXk8c3RyaW5nPiB8IG51bGwsXG4gICAgZXhwZWN0ZWRDYW5vbmljYWxSZXF1ZXN0OiBzdHJpbmcsXG4gICAgZWNjUHViS2V5WDogc3RyaW5nLFxuICAgIGVjY1B1YktleVk6IHN0cmluZyxcbiAgICBvcHRpb25zOiBSZXF1ZXN0UHJlc2lnbmluZ0FyZ3VtZW50cyA9IHt9XG4gICk6IFByb21pc2U8Ym9vbGVhbj4ge1xuICAgIGlmICh0eXBlb2Ygc2lnbmF0dXJlICE9IFwic3RyaW5nXCIpIHtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG4gICAgY29uc3Qgc2RrUmVxdWVzdCA9IHByZXBhcmVSZXF1ZXN0KHJlcXVlc3QpO1xuICAgIGNvbnN0IGNydFJlcXVlc3QgPSBzZGtIdHRwUmVxdWVzdDJjcnRIdHRwUmVxdWVzdChzZGtSZXF1ZXN0KTtcbiAgICBjb25zdCBjcnRDb25maWcgPSBhd2FpdCB0aGlzLm9wdGlvbnMyY3J0Q29uZmlndXJlKFxuICAgICAgb3B0aW9ucyxcbiAgICAgIGZhbHNlIC8qIHZpYUhlYWRlciAqLyxcbiAgICAgIGF3YWl0IGdldFBheWxvYWRIYXNoKHJlcXVlc3QsIHRoaXMuc2hhMjU2KSxcbiAgICAgIG9wdGlvbnMuZXhwaXJlc0luID8gb3B0aW9ucy5leHBpcmVzSW4gOiAzNjAwXG4gICAgKTtcbiAgICByZXR1cm4gY3J0QXV0aC5hd3NfdmVyaWZ5X3NpZ3Y0YV9zaWduaW5nKFxuICAgICAgY3J0UmVxdWVzdCxcbiAgICAgIGNydENvbmZpZyxcbiAgICAgIGV4cGVjdGVkQ2Fub25pY2FsUmVxdWVzdCxcbiAgICAgIHNpZ25hdHVyZSxcbiAgICAgIGVjY1B1YktleVgsXG4gICAgICBlY2NQdWJLZXlZXG4gICAgKTtcbiAgfVxufVxuXG5mdW5jdGlvbiBzZGsyY3J0Q3JlZGVudGlhbHNQcm92aWRlcihjcmVkZW50aWFsczogQ3JlZGVudGlhbHMpOiBjcnRBdXRoLkF3c0NyZWRlbnRpYWxzUHJvdmlkZXIge1xuICByZXR1cm4gY3J0QXV0aC5Bd3NDcmVkZW50aWFsc1Byb3ZpZGVyLm5ld1N0YXRpYyhcbiAgICBjcmVkZW50aWFscy5hY2Nlc3NLZXlJZCxcbiAgICBjcmVkZW50aWFscy5zZWNyZXRBY2Nlc3NLZXksXG4gICAgY3JlZGVudGlhbHMuc2Vzc2lvblRva2VuXG4gICk7XG59XG5cbmZ1bmN0aW9uIGdldEhlYWRlcnNVbnNpZ25hYmxlKHVuc2lnbmFibGVIZWFkZXJzPzogU2V0PHN0cmluZz4sIHNpZ25hYmxlSGVhZGVycz86IFNldDxzdHJpbmc+KTogc3RyaW5nW10ge1xuICBpZiAoIXVuc2lnbmFibGVIZWFkZXJzKSB7XG4gICAgcmV0dXJuIFtdO1xuICB9XG4gIGlmICghc2lnbmFibGVIZWFkZXJzKSB7XG4gICAgcmV0dXJuIFsuLi51bnNpZ25hYmxlSGVhZGVyc107XG4gIH1cbiAgY29uc3QgcmVzdWx0ID0gbmV3IFNldChbLi4udW5zaWduYWJsZUhlYWRlcnNdKTtcbiAgZm9yIChsZXQgaXQgPSBzaWduYWJsZUhlYWRlcnMudmFsdWVzKCksIHZhbCA9IG51bGw7ICh2YWwgPSBpdC5uZXh0KCkudmFsdWUpOyApIHtcbiAgICBpZiAocmVzdWx0Lmhhcyh2YWwpKSB7XG4gICAgICByZXN1bHQuZGVsZXRlKHZhbCk7XG4gICAgfVxuICB9XG4gIHJldHVybiBbLi4ucmVzdWx0XTtcbn1cbiJdfQ==
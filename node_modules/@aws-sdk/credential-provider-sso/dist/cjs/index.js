"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.isSsoProfile = exports.validateSsoProfile = exports.fromSSO = exports.EXPIRE_WINDOW_MS = void 0;
const client_sso_1 = require("@aws-sdk/client-sso");
const property_provider_1 = require("@aws-sdk/property-provider");
const shared_ini_file_loader_1 = require("@aws-sdk/shared-ini-file-loader");
const util_credentials_1 = require("@aws-sdk/util-credentials");
const crypto_1 = require("crypto");
const fs_1 = require("fs");
const path_1 = require("path");
/**
 * The time window (15 mins) that SDK will treat the SSO token expires in before the defined expiration date in token.
 * This is needed because server side may have invalidated the token before the defined expiration date.
 *
 * @internal
 */
exports.EXPIRE_WINDOW_MS = 15 * 60 * 1000;
const SHOULD_FAIL_CREDENTIAL_CHAIN = false;
/**
 * Creates a credential provider that will read from a credential_process specified
 * in ini files.
 */
const fromSSO = (init = {}) => async () => {
    const { ssoStartUrl, ssoAccountId, ssoRegion, ssoRoleName, ssoClient } = init;
    if (!ssoStartUrl && !ssoAccountId && !ssoRegion && !ssoRoleName) {
        // Load the SSO config from shared AWS config file.
        const profiles = await (0, util_credentials_1.parseKnownFiles)(init);
        const profileName = (0, util_credentials_1.getMasterProfileName)(init);
        const profile = profiles[profileName];
        if (!(0, exports.isSsoProfile)(profile)) {
            throw new property_provider_1.CredentialsProviderError(`Profile ${profileName} is not configured with SSO credentials.`);
        }
        const { sso_start_url, sso_account_id, sso_region, sso_role_name } = (0, exports.validateSsoProfile)(profile);
        return resolveSSOCredentials({
            ssoStartUrl: sso_start_url,
            ssoAccountId: sso_account_id,
            ssoRegion: sso_region,
            ssoRoleName: sso_role_name,
            ssoClient: ssoClient,
        });
    }
    else if (!ssoStartUrl || !ssoAccountId || !ssoRegion || !ssoRoleName) {
        throw new property_provider_1.CredentialsProviderError('Incomplete configuration. The fromSSO() argument hash must include "ssoStartUrl",' +
            ' "ssoAccountId", "ssoRegion", "ssoRoleName"');
    }
    else {
        return resolveSSOCredentials({ ssoStartUrl, ssoAccountId, ssoRegion, ssoRoleName, ssoClient });
    }
};
exports.fromSSO = fromSSO;
const resolveSSOCredentials = async ({ ssoStartUrl, ssoAccountId, ssoRegion, ssoRoleName, ssoClient, }) => {
    const hasher = (0, crypto_1.createHash)("sha1");
    const cacheName = hasher.update(ssoStartUrl).digest("hex");
    const tokenFile = (0, path_1.join)((0, shared_ini_file_loader_1.getHomeDir)(), ".aws", "sso", "cache", `${cacheName}.json`);
    let token;
    try {
        token = JSON.parse((0, fs_1.readFileSync)(tokenFile, { encoding: "utf-8" }));
        if (new Date(token.expiresAt).getTime() - Date.now() <= exports.EXPIRE_WINDOW_MS) {
            throw new Error("SSO token is expired.");
        }
    }
    catch (e) {
        throw new property_provider_1.CredentialsProviderError(`The SSO session associated with this profile has expired or is otherwise invalid. To refresh this SSO session ` +
            `run aws sso login with the corresponding profile.`, SHOULD_FAIL_CREDENTIAL_CHAIN);
    }
    const { accessToken } = token;
    const sso = ssoClient || new client_sso_1.SSOClient({ region: ssoRegion });
    let ssoResp;
    try {
        ssoResp = await sso.send(new client_sso_1.GetRoleCredentialsCommand({
            accountId: ssoAccountId,
            roleName: ssoRoleName,
            accessToken,
        }));
    }
    catch (e) {
        throw property_provider_1.CredentialsProviderError.from(e, SHOULD_FAIL_CREDENTIAL_CHAIN);
    }
    const { roleCredentials: { accessKeyId, secretAccessKey, sessionToken, expiration } = {} } = ssoResp;
    if (!accessKeyId || !secretAccessKey || !sessionToken || !expiration) {
        throw new property_provider_1.CredentialsProviderError("SSO returns an invalid temporary credential.", SHOULD_FAIL_CREDENTIAL_CHAIN);
    }
    return { accessKeyId, secretAccessKey, sessionToken, expiration: new Date(expiration) };
};
/**
 * @internal
 */
const validateSsoProfile = (profile) => {
    const { sso_start_url, sso_account_id, sso_region, sso_role_name } = profile;
    if (!sso_start_url || !sso_account_id || !sso_region || !sso_role_name) {
        throw new property_provider_1.CredentialsProviderError(`Profile is configured with invalid SSO credentials. Required parameters "sso_account_id", "sso_region", ` +
            `"sso_role_name", "sso_start_url". Got ${Object.keys(profile).join(", ")}\nReference: https://docs.aws.amazon.com/cli/latest/userguide/cli-configure-sso.html`, SHOULD_FAIL_CREDENTIAL_CHAIN);
    }
    return profile;
};
exports.validateSsoProfile = validateSsoProfile;
/**
 * @internal
 */
const isSsoProfile = (arg) => arg &&
    (typeof arg.sso_start_url === "string" ||
        typeof arg.sso_account_id === "string" ||
        typeof arg.sso_region === "string" ||
        typeof arg.sso_role_name === "string");
exports.isSsoProfile = isSsoProfile;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvaW5kZXgudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEsb0RBQTRHO0FBQzVHLGtFQUFzRTtBQUN0RSw0RUFBc0U7QUFFdEUsZ0VBQXFHO0FBQ3JHLG1DQUFvQztBQUNwQywyQkFBa0M7QUFDbEMsK0JBQTRCO0FBRTVCOzs7OztHQUtHO0FBQ1UsUUFBQSxnQkFBZ0IsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLElBQUksQ0FBQztBQUUvQyxNQUFNLDRCQUE0QixHQUFHLEtBQUssQ0FBQztBQXVDM0M7OztHQUdHO0FBQ0ksTUFBTSxPQUFPLEdBQ2xCLENBQUMsT0FBd0QsRUFBUyxFQUFzQixFQUFFLENBQzFGLEtBQUssSUFBSSxFQUFFO0lBQ1QsTUFBTSxFQUFFLFdBQVcsRUFBRSxZQUFZLEVBQUUsU0FBUyxFQUFFLFdBQVcsRUFBRSxTQUFTLEVBQUUsR0FBRyxJQUFJLENBQUM7SUFDOUUsSUFBSSxDQUFDLFdBQVcsSUFBSSxDQUFDLFlBQVksSUFBSSxDQUFDLFNBQVMsSUFBSSxDQUFDLFdBQVcsRUFBRTtRQUMvRCxtREFBbUQ7UUFDbkQsTUFBTSxRQUFRLEdBQUcsTUFBTSxJQUFBLGtDQUFlLEVBQUMsSUFBSSxDQUFDLENBQUM7UUFDN0MsTUFBTSxXQUFXLEdBQUcsSUFBQSx1Q0FBb0IsRUFBQyxJQUFJLENBQUMsQ0FBQztRQUMvQyxNQUFNLE9BQU8sR0FBRyxRQUFRLENBQUMsV0FBVyxDQUFDLENBQUM7UUFDdEMsSUFBSSxDQUFDLElBQUEsb0JBQVksRUFBQyxPQUFPLENBQUMsRUFBRTtZQUMxQixNQUFNLElBQUksNENBQXdCLENBQUMsV0FBVyxXQUFXLDBDQUEwQyxDQUFDLENBQUM7U0FDdEc7UUFDRCxNQUFNLEVBQUUsYUFBYSxFQUFFLGNBQWMsRUFBRSxVQUFVLEVBQUUsYUFBYSxFQUFFLEdBQUcsSUFBQSwwQkFBa0IsRUFBQyxPQUFPLENBQUMsQ0FBQztR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LEVBQUUsVUFBVSxFQUFFLElBQUksSUFBSSxDQUFDLFVBQVUsQ0FBQyxFQUFFLENBQUM7QUFDMUYsQ0FBQyxDQUFDO0FBWUY7O0dBRUc7QUFDSSxNQUFNLGtCQUFrQixHQUFHLENBQUMsT0FBNEIsRUFBYyxFQUFFO0lBQzdFLE1BQU0sRUFBRSxhQUFhLEVBQUUsY0FBYyxFQUFFLFVBQVUsRUFBRSxhQUFhLEVBQUUsR0FBRyxPQUFPLENBQUM7SUFDN0UsSUFBSSxDQUFDLGFBQWEsSUFBSSxDQUFDLGNBQWMsSUFBSSxDQUFDLFVBQVUsSUFBSSxDQUFDLGFBQWEsRUFBRTtRQUN0RSxNQUFNLElBQUksNENBQXdCLENBQ2hDLDBHQUEwRztZQUN4Ryx5Q0FBeUMsTUFBTSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQyxJQUFJLENBQ2hFLElBQUksQ0FDTCxzRkFBc0YsRUFDekYsNEJBQTRCLENBQzdCLENBQUM7S0FDSDtJQUNELE9BQU8sT0FBcUIsQ0FBQztBQUMvQixDQUFDLENBQUM7QUFaVyxRQUFBLGtCQUFrQixzQkFZN0I7QUFFRjs7R0FFRztBQUNJLE1BQU0sWUFBWSxHQUFHLENBQUMsR0FBWSxFQUE4QixFQUFFLENBQ3ZFLEdBQUc7SUFDSCxDQUFDLE9BQU8sR0FBRyxDQUFDLGFBQWEsS0FBSyxRQUFRO1FBQ3BDLE9BQU8sR0FBRyxDQUFDLGNBQWMsS0FBSyxRQUFRO1FBQ3RDLE9BQU8sR0FBRyxDQUFDLFVBQVUsS0FBSyxRQUFRO1FBQ2xDLE9BQU8sR0FBRyxDQUFDLGFBQWEsS0FBSyxRQUFRLENBQUMsQ0FBQztBQUw5QixRQUFBLFlBQVksZ0JBS2tCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgR2V0Um9sZUNyZWRlbnRpYWxzQ29tbWFuZCwgR2V0Um9sZUNyZWRlbnRpYWxzQ29tbWFuZE91dHB1dCwgU1NPQ2xpZW50IH0gZnJvbSBcIkBhd3Mtc2RrL2NsaWVudC1zc29cIjtcbmltcG9ydCB7IENyZWRlbnRpYWxzUHJvdmlkZXJFcnJvciB9IGZyb20gXCJAYXdzLXNkay9wcm9wZXJ0eS1wcm92aWRlclwiO1xuaW1wb3J0IHsgZ2V0SG9tZURpciwgUHJvZmlsZSB9IGZyb20gXCJAYXdzLXNkay9zaGFyZWQtaW5pLWZpbGUtbG9hZGVyXCI7XG5pbXBvcnQgeyBDcmVkZW50aWFsUHJvdmlkZXIsIENyZWRlbnRpYWxzIH0gZnJvbSBcIkBhd3Mtc2RrL3R5cGVzXCI7XG5pbXBvcnQgeyBnZXRNYXN0ZXJQcm9maWxlTmFtZSwgcGFyc2VLbm93bkZpbGVzLCBTb3VyY2VQcm9maWxlSW5pdCB9IGZyb20gXCJAYXdzLXNkay91dGlsLWNyZWRlbnRpYWxzXCI7XG5pbXBvcnQgeyBjcmVhdGVIYXNoIH0gZnJvbSBcImNyeXB0b1wiO1xuaW1wb3J0IHsgcmVhZEZpbGVTeW5jIH0gZnJvbSBcImZzXCI7XG5pbXBvcnQgeyBqb2luIH0gZnJvbSBcInBhdGhcIjtcblxuLyoqXG4gKiBUaGUgdGltZSB3aW5kb3cgKDE1IG1pbnMpIHRoYXQgU0RLIHdpbGwgdHJlYXQgdGhlIFNTTyB0b2tlbiBleHBpcmVzIGluIGJlZm9yZSB0aGUgZGVmaW5lZCBleHBpcmF0aW9uIGRhdGUgaW4gdG9rZW4uXG4gKiBUaGlzIGlzIG5lZWRlZCBiZWNhdXNlIHNlcnZlciBzaWRlIG1heSBoYXZlIGludmFsaWRhdGVkIHRoZSB0b2tlbiBiZWZvcmUgdGhlIGRlZmluZWQgZXhwaXJhdGlvbiBkYXRlLlxuICpcbiAqIEBpbnRlcm5hbFxuICovXG5leHBvcnQgY29uc3QgRVhQSVJFX1dJTkRPV19NUyA9IDE1ICogNjAgKiAxMDAwO1xuXG5jb25zdCBTSE9VTERfRkFJTF9DUkVERU5USUFMX0NIQUlOID0gZmFsc2U7XG5cbi8qKlxuICogQ2FjaGVkIFNTTyB0b2tlbiByZXRyaWV2ZWQgZnJvbSBTU08gbG9naW4gZmxvdy5cbiAqL1xuaW50ZXJmYWNlIFNTT1Rva2VuIHtcbiAgLy8gQSBiYXNlNjQgZW5jb2RlZCBzdHJpbmcgcmV0dXJuZWQgYnkgdGhlIHNzby1vaWRjIHNlcnZpY2UuXG4gIGFjY2Vzc1Rva2VuOiBzdHJpbmc7XG4gIC8vIFJGQzMzMzkgZm9ybWF0IHRpbWVzdGFtcFxuICBleHBpcmVzQXQ6IHN0cmluZztcbiAgcmVnaW9uPzogc3RyaW5nO1xuICBzdGFydFVybD86IHN0cmluZztcbn1cblxuZXhwb3J0IGludGVyZmFjZSBTc29DcmVkZW50aWFsc1BhcmFtZXRlcnMge1xuICAvKipcbiAgICogVGhlIFVSTCB0byB0aGUgQVdTIFNTTyBzZXJ2aWNlLlxuICAgKi9cbiAgc3NvU3RhcnRVcmw6IHN0cmluZztcblxuICAvKipcbiAgICogVGhlIElEIG9mIHRoZSBBV1MgYWNjb3VudCB0byB1c2UgZm9yIHRlbXBvcmFyeSBjcmVkZW50aWFscy5cbiAgICovXG4gIHNzb0FjY291bnRJZDogc3RyaW5nO1xuXG4gIC8qKlxuICAgKiBUaGUgQVdTIHJlZ2lvbiB0byB1c2UgZm9yIHRlbXBvcmFyeSBjcmVkZW50aWFscy5cbiAgICovXG4gIHNzb1JlZ2lvbjogc3RyaW5nO1xuXG4gIC8qKlxuICAgKiBUaGUgbmFtZSBvZiB0aGUgQVdTIHJvbGUgdG8gYXNzdW1lLlxuICAgKi9cbiAgc3NvUm9sZU5hbWU6IHN0cmluZztcbn1cbmV4cG9ydCBpbnRlcmZhY2UgRnJvbVNTT0luaXQgZXh0ZW5kcyBTb3VyY2VQcm9maWxlSW5pdCB7XG4gIHNzb0NsaWVudD86IFNTT0NsaWVudDtcbn1cblxuLyoqXG4gKiBDcmVhdGVzIGEgY3JlZGVudGlhbCBwcm92aWRlciB0aGF0IHdpbGwgcmVhZCBmcm9tIGEgY3JlZGVudGlhbF9wcm9jZXNzIHNwZWNpZmllZFxuICogaW4gaW5pIGZpbGVzLlxuICovXG5leHBvcnQgY29uc3QgZnJvbVNTTyA9XG4gIChpbml0OiBGcm9tU1NPSW5pdCAmIFBhcnRpYWw8U3NvQ3JlZGVudGlhbHNQYXJhbWV0ZXJzPiA9IHt9IGFzIGFueSk6IENyZWRlbnRpYWxQcm92aWRlciA9PlxuICBhc3luYyAoKSA9PiB7XG4gICAgY29uc3QgeyBzc29TdGFydFVybCwgc3NvQWNjb3VudElkLCBzc29SZWdpb24sIHNzb1JvbGVOYW1lLCBzc29DbGllbnQgfSA9IGluaXQ7XG4gICAgaWYgKCFzc29TdGFydFVybCAmJiAhc3NvQWNjb3VudElkICYmICFzc29SZWdpb24gJiYgIXNzb1JvbGVOYW1lKSB7XG4gICAgICAvLyBMb2FkIHRoZSBTU08gY29uZmlnIGZyb20gc2hhcmVkIEFXUyBjb25maWcgZmlsZS5cbiAgICAgIGNvbnN0IHByb2ZpbGVzID0gYXdhaXQgcGFyc2VLbm93bkZpbGVzKGluaXQpO1xuICAgICAgY29uc3QgcHJvZmlsZU5hbWUgPSBnZXRNYXN0ZXJQcm9maWxlTmFtZShpbml0KTtcbiAgICAgIGNvbnN0IHByb2ZpbGUgPSBwcm9maWxlc1twcm9maWxlTmFtZV07XG4gICAgICBpZiAoIWlzU3NvUHJvZmlsZShwcm9maWxlKSkge1xuICAgICAgICB0aHJvdyBuZXcgQ3JlZGVudGlhbHNQcm92aWRlckVycm9yKGBQcm9maWxlICR7cHJvZmlsZU5hbWV9IGlzIG5vdCBjb25maWd1cmVkIHdpdGggU1NPIGNyZWRlbnRpYWxzLmApO1xuICAgICAgfVxuICAgICAgY29uc3QgeyBzc29fc3RhcnRfdXJsLCBzc29fYWNjb3VudF9pZCwgc3NvX3JlZ2lvbiwgc3NvX3JvbGVfbmFtZSB9ID0gdmFsaWRhdGVTc29Qcm9maWxlKHByb2ZpbGUpO1xuICAgICAgcmV0dXJuIHJlc29sdmVTU09DcmVkZW50aWFscyh7XG4gICAgICAgIHNzb1N0YXJ0VXJsOiBzc29fc3RhcnRfdXJsLFxuICAgICAgICBzc29BY2NvdW50SWQ6IHNzb19hY2NvdW50X2lkLFxuICAgICAgICBzc29SZWdpb246IHNzb19yZWdpb24sXG4gICAgICAgIHNzb1JvbGVOYW1lOiBzc29fcm9sZV9uYW1lLFxuICAgICAgICBzc29DbGllbnQ6IHNzb0NsaWVudCxcbiAgICAgIH0pO1xuICAgIH0gZWxzZSBpZiAoIXNzb1N0YXJ0VXJsIHx8ICFzc29BY2NvdW50SWQgfHwgIXNzb1JlZ2lvbiB8fCAhc3NvUm9sZU5hbWUpIHtcbiAgICAgIHRocm93IG5ldyBDcmVkZW50aWFsc1Byb3ZpZGVyRXJyb3IoXG4gICAgICAgICdJbmNvbXBsZXRlIGNvbmZpZ3VyYXRpb24uIFRoZSBmcm9tU1NPKCkgYXJndW1lbnQgaGFzaCBtdXN0IGluY2x1ZGUgXCJzc29TdGFydFVybFwiLCcgK1xuICAgICAgICAgICcgXCJzc29BY2NvdW50SWRcIiwgXCJzc29SZWdpb25cIiwgXCJzc29Sb2xlTmFtZVwiJ1xuICAgICAgKTtcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIHJlc29sdmVTU09DcmVkZW50aWFscyh7IHNzb1N0YXJ0VXJsLCBzc29BY2NvdW50SWQsIHNzb1JlZ2lvbiwgc3NvUm9sZU5hbWUsIHNzb0NsaWVudCB9KTtcbiAgICB9XG4gIH07XG5cbmNvbnN0IHJlc29sdmVTU09DcmVkZW50aWFscyA9IGFzeW5jICh7XG4gIHNzb1N0YXJ0VXJsLFxuICBzc29BY2NvdW50SWQsXG4gIHNzb1JlZ2lvbixcbiAgc3NvUm9sZU5hbWUsXG4gIHNzb0NsaWVudCxcbn06IEZyb21TU09Jbml0ICYgU3NvQ3JlZGVudGlhbHNQYXJhbWV0ZXJzKTogUHJvbWlzZTxDcmVkZW50aWFscz4gPT4ge1xuICBjb25zdCBoYXNoZXIgPSBjcmVhdGVIYXNoKFwic2hhMVwiKTtcbiAgY29uc3QgY2FjaGVOYW1lID0gaGFzaGVyLnVwZGF0ZShzc29TdGFydFVybCkuZGlnZXN0KFwiaGV4XCIpO1xuICBjb25zdCB0b2tlbkZpbGUgPSBqb2luKGdldEhvbWVEaXIoKSwgXCIuYXdzXCIsIFwic3NvXCIsIFwiY2FjaGVcIiwgYCR7Y2FjaGVOYW1lfS5qc29uYCk7XG4gIGxldCB0b2tlbjogU1NPVG9rZW47XG4gIHRyeSB7XG4gICAgdG9rZW4gPSBKU09OLnBhcnNlKHJlYWRGaWxlU3luYyh0b2tlbkZpbGUsIHsgZW5jb2Rpbmc6IFwidXRmLThcIiB9KSk7XG4gICAgaWYgKG5ldyBEYXRlKHRva2VuLmV4cGlyZXNBdCkuZ2V0VGltZSgpIC0gRGF0ZS5ub3coKSA8PSBFWFBJUkVfV0lORE9XX01TKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXCJTU08gdG9rZW4gaXMgZXhwaXJlZC5cIik7XG4gICAgfVxuICB9IGNhdGNoIChlKSB7XG4gICAgdGhyb3cgbmV3IENyZWRlbnRpYWxzUHJvdmlkZXJFcnJvcihcbiAgICAgIGBUaGUgU1NPIHNlc3Npb24gYXNzb2NpYXRlZCB3aXRoIHRoaXMgcHJvZmlsZSBoYXMgZXhwaXJlZCBvciBpcyBvdGhlcndpc2UgaW52YWxpZC4gVG8gcmVmcmVzaCB0aGlzIFNTTyBzZXNzaW9uIGAgK1xuICAgICAgICBgcnVuIGF3cyBzc28gbG9naW4gd2l0aCB0aGUgY29ycmVzcG9uZGluZyBwcm9maWxlLmAsXG4gICAgICBTSE9VTERfRkFJTF9DUkVERU5USUFMX0NIQUlOXG4gICAgKTtcbiAgfVxuICBjb25zdCB7IGFjY2Vzc1Rva2VuIH0gPSB0b2tlbjtcbiAgY29uc3Qgc3NvID0gc3NvQ2xpZW50IHx8IG5ldyBTU09DbGllbnQoeyByZWdpb246IHNzb1JlZ2lvbiB9KTtcbiAgbGV0IHNzb1Jlc3A6IEdldFJvbGVDcmVkZW50aWFsc0NvbW1hbmRPdXRwdXQ7XG4gIHRyeSB7XG4gICAgc3NvUmVzcCA9IGF3YWl0IHNzby5zZW5kKFxuICAgICAgbmV3IEdldFJvbGVDcmVkZW50aWFsc0NvbW1hbmQoe1xuICAgICAgICBhY2NvdW50SWQ6IHNzb0FjY291bnRJZCxcbiAgICAgICAgcm9sZU5hbWU6IHNzb1JvbGVOYW1lLFxuICAgICAgICBhY2Nlc3NUb2tlbixcbiAgICAgIH0pXG4gICAgKTtcbiAgfSBjYXRjaCAoZSkge1xuICAgIHRocm93IENyZWRlbnRpYWxzUHJvdmlkZXJFcnJvci5mcm9tKGUsIFNIT1VMRF9GQUlMX0NSRURFTlRJQUxfQ0hBSU4pO1xuICB9XG4gIGNvbnN0IHsgcm9sZUNyZWRlbnRpYWxzOiB7IGFjY2Vzc0tleUlkLCBzZWNyZXRBY2Nlc3NLZXksIHNlc3Npb25Ub2tlbiwgZXhwaXJhdGlvbiB9ID0ge30gfSA9IHNzb1Jlc3A7XG4gIGlmICghYWNjZXNzS2V5SWQgfHwgIXNlY3JldEFjY2Vzc0tleSB8fCAhc2Vzc2lvblRva2VuIHx8ICFleHBpcmF0aW9uKSB7XG4gICAgdGhyb3cgbmV3IENyZWRlbnRpYWxzUHJvdmlkZXJFcnJvcihcIlNTTyByZXR1cm5zIGFuIGludmFsaWQgdGVtcG9yYXJ5IGNyZWRlbnRpYWwuXCIsIFNIT1VMRF9GQUlMX0NSRURFTlRJQUxfQ0hBSU4pO1xuICB9XG4gIHJldHVybiB7IGFjY2Vzc0tleUlkLCBzZWNyZXRBY2Nlc3NLZXksIHNlc3Npb25Ub2tlbiwgZXhwaXJhdGlvbjogbmV3IERhdGUoZXhwaXJhdGlvbikgfTtcbn07XG5cbi8qKlxuICogQGludGVybmFsXG4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgU3NvUHJvZmlsZSBleHRlbmRzIFByb2ZpbGUge1xuICBzc29fc3RhcnRfdXJsOiBzdHJpbmc7XG4gIHNzb19hY2NvdW50X2lkOiBzdHJpbmc7XG4gIHNzb19yZWdpb246IHN0cmluZztcbiAgc3NvX3JvbGVfbmFtZTogc3RyaW5nO1xufVxuXG4vKipcbiAqIEBpbnRlcm5hbFxuICovXG5leHBvcnQgY29uc3QgdmFsaWRhdGVTc29Qcm9maWxlID0gKHByb2ZpbGU6IFBhcnRpYWw8U3NvUHJvZmlsZT4pOiBTc29Qcm9maWxlID0+IHtcbiAgY29uc3QgeyBzc29fc3RhcnRfdXJsLCBzc29fYWNjb3VudF9pZCwgc3NvX3JlZ2lvbiwgc3NvX3JvbGVfbmFtZSB9ID0gcHJvZmlsZTtcbiAgaWYgKCFzc29fc3RhcnRfdXJsIHx8ICFzc29fYWNjb3VudF9pZCB8fCAhc3NvX3JlZ2lvbiB8fCAhc3NvX3JvbGVfbmFtZSkge1xuICAgIHRocm93IG5ldyBDcmVkZW50aWFsc1Byb3ZpZGVyRXJyb3IoXG4gICAgICBgUHJvZmlsZSBpcyBjb25maWd1cmVkIHdpdGggaW52YWxpZCBTU08gY3JlZGVudGlhbHMuIFJlcXVpcmVkIHBhcmFtZXRlcnMgXCJzc29fYWNjb3VudF9pZFwiLCBcInNzb19yZWdpb25cIiwgYCArXG4gICAgICAgIGBcInNzb19yb2xlX25hbWVcIiwgXCJzc29fc3RhcnRfdXJsXCIuIEdvdCAke09iamVjdC5rZXlzKHByb2ZpbGUpLmpvaW4oXG4gICAgICAgICAgXCIsIFwiXG4gICAgICAgICl9XFxuUmVmZXJlbmNlOiBodHRwczovL2RvY3MuYXdzLmFtYXpvbi5jb20vY2xpL2xhdGVzdC91c2VyZ3VpZGUvY2xpLWNvbmZpZ3VyZS1zc28uaHRtbGAsXG4gICAgICBTSE9VTERfRkFJTF9DUkVERU5USUFMX0NIQUlOXG4gICAgKTtcbiAgfVxuICByZXR1cm4gcHJvZmlsZSBhcyBTc29Qcm9maWxlO1xufTtcblxuLyoqXG4gKiBAaW50ZXJuYWxcbiAqL1xuZXhwb3J0IGNvbnN0IGlzU3NvUHJvZmlsZSA9IChhcmc6IFByb2ZpbGUpOiBhcmcgaXMgUGFydGlhbDxTc29Qcm9maWxlPiA9PlxuICBhcmcgJiZcbiAgKHR5cGVvZiBhcmcuc3NvX3N0YXJ0X3VybCA9PT0gXCJzdHJpbmdcIiB8fFxuICAgIHR5cGVvZiBhcmcuc3NvX2FjY291bnRfaWQgPT09IFwic3RyaW5nXCIgfHxcbiAgICB0eXBlb2YgYXJnLnNzb19yZWdpb24gPT09IFwic3RyaW5nXCIgfHxcbiAgICB0eXBlb2YgYXJnLnNzb19yb2xlX25hbWUgPT09IFwic3RyaW5nXCIpO1xuIl19